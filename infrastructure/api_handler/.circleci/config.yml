version: 2.1

executors:
  default:
    docker:
      - image: hashicorp/terraform:1.2.7

workflows:
  tf-api_handler:
    when: << pipeline.parameters.tf-api_handler >>
    jobs:
      - tf-test:
          target-env: "sand/dshah"
          appName   : "api_handler"
          context: 
            - cicd-deployer-aws-user
      - tf-plan:
          target-env: "sand/dshah"
          appName   : "api_handler"
          context: 
            - cicd-deployer-aws-user
          requires:
            - tf-test
      - tf-apply:
          target-env: "sand/dshah"
          appName   : "api_handler"
          context: 
            - cicd-deployer-aws-user
          filters:
            branches:
              only: main
          requires:
            - tf-plan